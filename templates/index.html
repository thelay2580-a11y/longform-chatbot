<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì‡¼ì¸  íŠ¸ë Œë“œ íƒìƒ‰ê¸°</title>
  <style>
    body { font-family: system-ui, -apple-system, "Apple SD Gothic Neo", sans-serif; margin: 16px; }
    input, select, button, textarea { padding: 10px; margin: 6px 0; width: 100%; max-width: 720px; box-sizing: border-box; }
    textarea { min-height: 92px; }
    table { border-collapse: collapse; width: 100%; margin-top: 16px; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; vertical-align: top; }
    th { background: #f5f5f5; }
    .hint { color: #555; font-size: 13px; margin: 10px 0; max-width: 720px; line-height: 1.35; }
    .rowbtn { width: auto; padding: 8px 10px; }
    pre { white-space: pre-wrap; border: 1px solid #ddd; padding: 12px; margin-top: 12px; max-width: 980px; }
  </style>
</head>
<body>
  <h2>ì‡¼ì¸  íŠ¸ë Œë“œ íƒìƒ‰ê¸° (ë¡œì»¬ í…ŒìŠ¤íŠ¸)</h2>

  <div class="hint">
    âœ… ì‚¬ìš© íë¦„: (1) ê²€ìƒ‰ â†’ (2) TOP 1~100 ì¤‘ ì„ íƒ â†’ (3) í•µì‹¬ ìš”ì•½ 3~4ì¤„ ì…ë ¥(ê°€ëŠ¥í•˜ë©´) â†’ (4) [ğŸ“‹ ì œì‘ ì§€ì¹¨ ë³µì‚¬] â†’ (5) ë‹¤ë¥¸ í•™ìŠµ AIì— ë¶™ì—¬ë„£ê¸°<br/>
    - <b>í˜¼í•© ì¶”ì²œìˆœ</b>: í­ë°œ+ì¬í˜„ ì ˆì¶© / <b>íŠ¸ë˜í”½ í­ë°œìˆœ</b>: v/h ì¤‘ì‹¬ / <b>ì‹ ì¸ ì¬í˜„ìˆœ</b>: view/sub ì¤‘ì‹¬
  </div>

  <label>ê²€ìƒ‰ì–´</label>
  <input id="query" placeholder="ì˜ˆ: ì •ì¹˜, ë‰´ìŠ¤, ê±´ê°•, ì˜í•™, ì‹œë‹ˆì–´, ìƒí™œ" />

  <label>ê¸°ê°„</label>
  <select id="days">
    <option value="1">ì˜¤ëŠ˜(1ì¼)</option>
    <option value="3" selected>ìµœê·¼ 3ì¼</option>
    <option value="7">ìµœê·¼ 7ì¼</option>
    <option value="30">ìµœê·¼ 30ì¼</option>
  </select>

  <label>ìµœì†Œ ì¡°íšŒìˆ˜(í•„í„°)</label>
  <input id="min_views" type="number" value="5000" />

  <label>ì •ë ¬ ê¸°ì¤€</label>
  <select id="sort_by">
    <option value="final" selected>í˜¼í•© ì¶”ì²œìˆœ</option>
    <option value="traffic">íŠ¸ë˜í”½ í­ë°œìˆœ</option>
    <option value="replication">ì‹ ì¸ ì¬í˜„ìˆœ</option>
  </select>

  <label>ì¹´í…Œê³ ë¦¬ (ë³µì‚¬ìš© ì§€ì¹¨ì— ë°˜ì˜)</label>
  <select id="category">
    <option value="politics_news" selected>ì •ì¹˜/ë‰´ìŠ¤/ì´ìŠˆ</option>
    <option value="health_life">ê±´ê°•/ì˜í•™/ì‹œë‹ˆì–´/ìƒí™œ</option>
  </select>

  <label>í•µì‹¬ ë‚´ìš© ìš”ì•½ (VIDEO_SUMMARY) â€” ê°€ëŠ¥í•˜ë©´ 3~4ì¤„ë¡œ ì…ë ¥</label>
  <textarea id="video_summary" placeholder="ì˜ˆ) 1) â—‹â—‹ ì •ì±… ë…¼ë€ í•µì‹¬ì€ â–³â–³  2) ë°˜ëŒ€/ì°¬ì„± ìŸì   3) ì‹œë‹ˆì–´ì—ê²Œ ì˜í–¥ í¬ì¸íŠ¸  4) ê²°ë¡ /ì£¼ì˜ì "></textarea>

  <button id="btn">íŠ¸ë Œë“œ ì°¾ê¸°(ë”ë¯¸ TOP100)</button>

  <div id="status" style="margin-top:10px;"></div>

  <table id="tbl" style="display:none;">
    <thead>
      <tr>
        <th>ìˆœìœ„</th>
        <th>ì ìˆ˜(í˜¼í•©/í­ë°œ/ì¬í˜„)</th>
        <th>ì œëª©/ë§í¬</th>
        <th>ì±„ë„</th>
        <th>ì¡°íšŒ</th>
        <th>ì¢‹ì•„ìš”</th>
        <th>v/h</th>
        <th>view/sub</th>
        <th>ì—…ë¡œë“œ</th>
        <th>ë³µì‚¬</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <pre id="resultBox" style="display:none;"></pre>

<script>
let LAST_ROWS = [];

const btn = document.getElementById("btn");
btn.onclick = async () => {
  const query = document.getElementById("query").value.trim();
  const days = parseInt(document.getElementById("days").value, 10);
  const min_views = parseInt(document.getElementById("min_views").value, 10);
  const sort_by = document.getElementById("sort_by").value;

  if (!query) { alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"); return; }

  document.getElementById("status").innerText = "ê°€ì ¸ì˜¤ëŠ” ì¤‘...";
  const res = await fetch("/api/trends", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ query, days, min_views, topn: 100, sort_by })
  });

  const data = await res.json();
  if (!res.ok) {
    document.getElementById("status").innerText = data.error || "ì˜¤ë¥˜";
    return;
  }

  const rows = data.rows || [];
  LAST_ROWS = rows;

  document.getElementById("status").innerText = `ê²°ê³¼ ${rows.length}ê°œ`;
  const tbody = document.querySelector("#tbl tbody");
  tbody.innerHTML = "";
  document.getElementById("tbl").style.display = rows.length ? "" : "none";

  rows.forEach((r, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>
        <div><b>${r.final_score}</b> (í˜¼í•©)</div>
        <div>${r.traffic_score} (í­ë°œ)</div>
        <div>${r.replication_score} (ì¬í˜„)</div>
      </td>
      <td><a href="${r.video_url}" target="_blank">${escapeHtml(r.title)}</a></td>
      <td><a href="${r.channel_url}" target="_blank">${escapeHtml(r.channel_title)}</a></td>
      <td>${r.views}</td>
      <td>${r.likes}</td>
      <td>${r.views_per_hour}</td>
      <td>${r.view_sub_ratio}</td>
      <td>${escapeHtml(r.published_at)}</td>
      <td><button class="rowbtn" onclick="copyBrief(${idx})">ğŸ“‹ ì œì‘ ì§€ì¹¨ ë³µì‚¬</button></td>
    `;
    tbody.appendChild(tr);
  });
};

function categoryLabel(v){
  return v === "health_life" ? "ê±´ê°•/ì˜í•™/ì‹œë‹ˆì–´/ìƒí™œ" : "ì •ì¹˜/ë‰´ìŠ¤/ì´ìŠˆ";
}

function buildBriefText(row, rank){
  const category = document.getElementById("category").value;
  const summary = (document.getElementById("video_summary").value || "").trim();

  const safeSummary = summary ? summary : "â€» (ìš”ì•½ ë¯¸ì…ë ¥) ì œëª©/ì§€í‘œ ê¸°ë°˜ìœ¼ë¡œ ë§¥ë½ì„ ì¶”ì •í•˜ë˜, í—ˆìœ„ ë‹¨ì • ì—†ì´ ì¬êµ¬ì„±í•˜ì„¸ìš”.";

  const imageStyle = (category === "politics_news")
    ? "Documentary news style, realistic, credible, newsroom atmosphere"
    : "Warm senior lifestyle style, empathetic, realistic, everyday Korean life mood";

  return `[íŠ¸ë Œë“œ ê¸°ë°˜ ì‡¼ì¸  ì œì‘ ì§€ì¹¨ v2]

1. ì°¸ê³  ì˜ìƒ ì •ë³´
- ì˜ìƒ ë§í¬: ${row.video_url}
- ì±„ë„: ${row.channel_title}
- ìµœê·¼ íŠ¸ë Œë“œ ìˆœìœ„: TOP ${rank} / 100
- ì¡°íšŒìˆ˜: ${row.views}
- ì¡°íšŒ ì†ë„(v/h): ${row.views_per_hour}
- êµ¬ë…ì ëŒ€ë¹„(view/sub): ${row.view_sub_ratio}

2. í•µì‹¬ ë‚´ìš© ìš”ì•½ (ê²€ìƒ‰ê¸°/ìš´ì˜ì ì…ë ¥)
${safeSummary}

3. ì œì‘ ìš”êµ¬ì‚¬í•­
- ëŒ€ë³¸ ê¸¸ì´: í•œêµ­ì–´ ë„ì–´ì“°ê¸° í¬í•¨ 300ì~400ì ë‚´ì™¸ (ë‚˜ë ˆì´ì…˜ 40~60ì´ˆ)
- ë§ˆì§€ë§‰ 5ì´ˆ: â€˜ì¢‹ì•„ìš” + êµ¬ë…â€™ ìì—°ìŠ¤ëŸ½ê²Œ ìœ ë„

4. ì¶œë ¥ ìš”ì²­ (ì•„ë˜ ìˆœì„œ)
â‘  í´ë¦­ ìœ ë„ ì œëª© 5ê°œ
â‘¡ ì¸ë„¤ì¼ ë¬¸êµ¬ 5ê°œ (15ì ë‚´ì™¸)
â‘¢ ì‡¼ì¸  ëŒ€ë³¸ 1ê°œ (300~400ì)
â‘£ ì˜ìƒ ì„¤ëª… 1ê°œ (2~3ì¤„)
â‘¤ íƒœê·¸ 20ê°œ (ì‰¼í‘œ)

â‘¥ ì¸ë„¤ì¼ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ 1ê°œ (ì˜ë¬¸)
- Korean person(s), Korean setting
- ${imageStyle}
- cinematic lighting, high contrast, 9:16, ultra realistic, no text, no subtitles

â‘¦ ì˜ìƒ ì¥ë©´ìš© ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ 6ê°œ (ì˜ë¬¸)
- ëŒ€ë³¸ íë¦„ì— ë§ì¶˜ ì¥ë©´ 6ê°œ
- Korean person(s), Korean setting
- ${imageStyle}
- each prompt independent, 9:16, ultra realistic, no text, no subtitles
`;
}

async function copyBrief(idx){
  const row = LAST_ROWS[idx];
  if (!row) return;

  const text = buildBriefText(row, idx + 1);

  const box = document.getElementById("resultBox");
  box.style.display = "";
  box.textContent = text;

  try {
    await navigator.clipboard.writeText(text);
    document.getElementById("status").innerText = "ë³µì‚¬ ì™„ë£Œ âœ… ë‹¤ë¥¸ í•™ìŠµ AIì— Ctrl+Vë¡œ ë¶™ì—¬ë„£ê¸°!";
  } catch (e) {
    document.getElementById("status").innerText = "ìë™ ë³µì‚¬ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ì œí•œ). ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ë“œë˜ê·¸í•´ì„œ Ctrl+Cë¡œ ë³µì‚¬í•˜ì„¸ìš”.";
  }
}

function escapeHtml(str){ return (str||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
</script>
</body>
</html>